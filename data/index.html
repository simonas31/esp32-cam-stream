<!DOCTYPE html>
<html>

<head>
    <title>ESP32 wifi connection</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1">
</head>

<body style="background-color: #eeeeee;">
    <div style="margin-left: auto; margin-right: auto; max-width: 350px; margin-top: 3rem;">
        <span style="color: #003366">
            <h1>Available Networks</h1>
            <p id="response"></p>
            <p>
                <select style="min-width: -webkit-fill-available;"
                        id="availableNetworks">
                    $OPTIONS$
                </select>
            </p>
            <p>
                <input type="password"
                       placeholder="Network password"
                       id="networkPassword"
                       style="min-width: -webkit-fill-available;" />
            </p>
            <p>
                <button type="button"
                        id="BTN_SEND_BACK">Connect</button>
            </p>
        </span>
    </div>
</body>
<script>
    var responseEl = document.getElementById("response");
    let nIntervId = null;
    document
        .getElementById("BTN_SEND_BACK")
        .addEventListener("click", connectToNetwork);

    function connectToNetwork() {
        var msg = {
            network_ssid: document.getElementById("availableNetworks").value,
            network_password: document.getElementById("networkPassword").value,
        };

        responseEl.style = "color: green;";
        responseEl.innerHTML = "Connecting to network. Please wait...";
        fetch('/connect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json' // Specify JSON content type
            },
            body: JSON.stringify(msg) // Convert data to JSON string
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                if (data == "Ok") {
                    nIntervId = setInterval(checkIfConnected, 2000);
                } else if (data == "Already Connected") {
                    responseEl.style = "color: blue;";
                    responseEl.innerHTML = "Connection is already established.";
                } else if (data == "Failed to Connect") {
                    responseEl.style = "color: red;";
                    responseEl.innerHTML = "Failed to connect. Check credentials or signal strength(try to refresh the page).";
                }
            })
            .catch(error => {
                responseEl.style = "color: red;";
                responseEl.innerHTML = "Could not connect to network. Please try again.";
            });
    }

    function checkIfConnected() {
        if (nIntervId != null) {
            fetch("/checkConnection", {
                method: 'GET',
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    if (data == "Ok") {
                        responseEl.style = "color: green;";
                        responseEl.innerHTML = "Connection was successfuly established.";
                    } else if (data == "Not Connected") {
                        responseEl.style = "color: red;";
                        responseEl.innerHTML = "Connection could no be established. Please try again.";
                    }

                    cleanInterval();
                })
                .catch(error => {
                    responseEl.style = "color: red;";
                    responseEl.innerHTML = "Could not connect to network.";

                    cleanInterval();
                });
        }

        function cleanInterval() {
            clearInterval(nIntervId);
            nIntervId = null;
        }
    }
</script>

</html>