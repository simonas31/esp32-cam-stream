<!DOCTYPE html>
<html>

<head>
    <title>ESP32 wifi connection</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1">
</head>

<body style="background-color: #eeeeee;">
    <div style="margin-left: auto; margin-right: auto; max-width: 350px; margin-top: 3rem;">
        <span style="color: #003366">
            <h1>Available Networks</h1>
            <p id="connection"
               style="color: chocolate;">
                <br />
            </p>
            <p id="response">
            </p>
            <p>
                <select style="min-width: -webkit-fill-available;"
                        id="availableNetworks">
                </select>
            </p>
            <p>
                <input type="password"
                       placeholder="Network password"
                       id="networkPassword"
                       style="min-width: -webkit-fill-available;" />
            </p>
            <p>
                <button type="button"
                        id="BTN_SEND_BACK">Connect</button>
            </p>
        </span>
    </div>
</body>
<script>
    var responseEl = document.getElementById("response");
    var connectionEl = document.getElementById("connection");
    let nIntervId = null;
    document
        .getElementById("BTN_SEND_BACK")
        .addEventListener("click", connectToNetwork);

    document.addEventListener("DOMContentLoaded", function () {
        // Your function here
        responseEl.style = "color: blue;";
        responseEl.innerHTML = "Searching for networks. Please wait.";
        getNetworks();
    });

    function connectToNetwork() {
        var msg = {
            network_ssid: document.getElementById("availableNetworks").value,
            network_password: document.getElementById("networkPassword").value,
        };

        connectionEl.innerText = "";
        responseEl.style = "color: green;";
        responseEl.innerHTML = "Connecting to network. Please wait...";
        fetch('/connect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json' // Specify JSON content type
            },
            body: JSON.stringify(msg) // Convert data to JSON string
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                if (data == "Ok") {
                    nIntervId = setInterval(checkIfConnected, 2000);
                } else if (data == "Already Connected") {
                    responseEl.style = "color: blue;";
                    responseEl.innerHTML = "Connection is already established.";
                } else if (data == "Failed to Connect") {
                    responseEl.style = "color: red;";
                    responseEl.innerHTML = "Failed to connect. Check credentials or signal strength(try to refresh the page).";
                }
            })
            .catch(error => {
                responseEl.style = "color: red;";
                responseEl.innerHTML = "Could not connect to network. Please try again.";
            });
    }

    function checkIfConnected() {
        if (nIntervId != null) {
            fetch("/checkConnection", {
                method: 'GET',
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    if (data == "Ok") {
                        responseEl.style = "color: green;";
                        responseEl.innerHTML = "Connection was successfuly established.";
                    } else if (data == "Not Connected") {
                        responseEl.style = "color: red;";
                        responseEl.innerHTML = "Connection could no be established. Please try again.";
                    }

                    cleanInterval();
                })
                .catch(error => {
                    responseEl.style = "color: red;";
                    responseEl.innerHTML = "Could not connect to network.";

                    cleanInterval();
                });
        }
    }

    function cleanInterval() {
        clearInterval(nIntervId);
        nIntervId = null;
    }

    function getNetworks() {
        fetch("/networks", {
            method: "GET",
        })
            .then(response => {
                return response.text();
            })
            .then(data => {
                var parsedData = "";
                try {
                    parsedData = JSON.parse(data);
                } catch (error) {
                    parsedData = "";
                }

                if (parsedData.length > 0) {
                    var select = document.getElementById("availableNetworks");
                    for (var i = 0; i < parsedData.length; i++) {
                        var option = document.createElement("option");
                        option.innerText = parsedData[i];
                        select.appendChild(option);
                    }

                    responseEl.style = "color: green;";
                    responseEl.innerHTML = "Networks received successfully.";
                } else if (data == "Could not find any networks.") {
                    responseEl.style = "color: red;";
                    responseEl.innerHTML = "Could not find any networks. Please try refreshing the page.";
                }
            })
            .catch(error => {
                responseEl.style = "color: red;";
                responseEl.innerHTML = "Could not find any networks. Please try refreshing the page.";
            });
    }
</script>

</html>